From ab1202f59fffd3e0160e60986e015e16ef09287b Mon Sep 17 00:00:00 2001
From: Mayur Pawashe <zorgiepoo@gmail.com>
Date: Sat, 20 Feb 2021 08:35:10 -0800
Subject: [PATCH 2/2] Merge pull request #1771 from sparkle-project/fix-1768

Fix XQuartz update failing because NSLog caused issues

(cherry picked from commit 1013c5076d640066d2278c53b76fd84fdcb76c84)
---
 Sparkle.xcodeproj/project.pbxproj  |  4 ++++
 Sparkle/Autoupdate/Autoupdate.m    |  6 ++++--
 Sparkle/SUFileManager.m            | 17 +++++++++--------
 Sparkle/SUGuidedPackageInstaller.m |  7 +++++++
 Sparkle/SUInstallerProtocol.h      |  2 ++
 Sparkle/SUPackageInstaller.m       |  5 +++++
 Sparkle/SUPlainInstaller.m         |  5 +++++
 7 files changed, 36 insertions(+), 10 deletions(-)

diff --git a/Sparkle.xcodeproj/project.pbxproj b/Sparkle.xcodeproj/project.pbxproj
index d3ddf893..f3611afc 100644
--- a/Sparkle.xcodeproj/project.pbxproj
+++ b/Sparkle.xcodeproj/project.pbxproj
@@ -277,6 +277,8 @@
 		72AC6B2A1B9AAF3A00F62325 /* SparkleTestCodeSignApp.tar.bz2 in Resources */ = {isa = PBXBuildFile; fileRef = 72AC6B291B9AAF3A00F62325 /* SparkleTestCodeSignApp.tar.bz2 */; };
 		72AC6B2C1B9AB0EE00F62325 /* SparkleTestCodeSignApp.tar.xz in Resources */ = {isa = PBXBuildFile; fileRef = 72AC6B2B1B9AB0EE00F62325 /* SparkleTestCodeSignApp.tar.xz */; };
 		72AC6B2E1B9B218C00F62325 /* SparkleTestCodeSignApp.dmg in Resources */ = {isa = PBXBuildFile; fileRef = 72AC6B2D1B9B218C00F62325 /* SparkleTestCodeSignApp.dmg */; };
+		72C4AB7A25E0B4C500D14562 /* SULog.m in Sources */ = {isa = PBXBuildFile; fileRef = 55C14F05136EF6DB00649790 /* SULog.m */; };
+		72C4ABAB25E0BF1900D14562 /* SULog.m in Sources */ = {isa = PBXBuildFile; fileRef = 55C14F05136EF6DB00649790 /* SULog.m */; };
 		72D4DAA11AD7632900B211E2 /* SUBinaryDeltaCreate.m in Sources */ = {isa = PBXBuildFile; fileRef = 7268AC621AD634C200C3E0C1 /* SUBinaryDeltaCreate.m */; };
 		72E1D7DD25A3E3AD0001BA6D /* SUWebViewCommon.m in Sources */ = {isa = PBXBuildFile; fileRef = 72E1D7D625A3E3AC0001BA6D /* SUWebViewCommon.m */; };
 		72E1D7DE25A3E3AD0001BA6D /* SUWebViewCommon.h in Headers */ = {isa = PBXBuildFile; fileRef = 72E1D7D725A3E3AC0001BA6D /* SUWebViewCommon.h */; };
@@ -2404,6 +2406,7 @@
 			isa = PBXSourcesBuildPhase;
 			buildActionMask = 2147483647;
 			files = (
+				72C4ABAB25E0BF1900D14562 /* SULog.m in Sources */,
 				14652F7D19A9726700959E44 /* SUBinaryDeltaApply.m in Sources */,
 				14652F7C19A9725300959E44 /* SUBinaryDeltaCommon.m in Sources */,
 				7268AC631AD634C200C3E0C1 /* SUBinaryDeltaCreate.m in Sources */,
@@ -2456,6 +2459,7 @@
 			isa = PBXSourcesBuildPhase;
 			buildActionMask = 2147483647;
 			files = (
+				72C4AB7A25E0B4C500D14562 /* SULog.m in Sources */,
 				722954B71D04ADAF00ECF9CA /* fileop.m in Sources */,
 				722954BD1D04AE3800ECF9CA /* SUConstants.m in Sources */,
 				722954BC1D04AE1100ECF9CA /* SUFileManager.m in Sources */,
diff --git a/Sparkle/Autoupdate/Autoupdate.m b/Sparkle/Autoupdate/Autoupdate.m
index 92c38e6b..9d48b1d1 100644
--- a/Sparkle/Autoupdate/Autoupdate.m
+++ b/Sparkle/Autoupdate/Autoupdate.m
@@ -136,7 +136,7 @@ - (void)install
         self.statusController = [[SUStatusController alloc] initWithHost:host];
         [self.statusController setButtonTitle:SULocalizedString(@"Cancel Update", @"") target:nil action:Nil isDefault:NO];
         [self.statusController beginActionWithTitle:SULocalizedString(@"Installing update...", @"")
-                                   maxProgressValue:100 statusText: @""];
+                                   maxProgressValue:installer.supportsDeterminateProgress ? 100 : 0 statusText: @""];
         [self.statusController showWindow:self];
     }
     
@@ -153,7 +153,9 @@ - (void)install
         
         void(^progressBlock)(double) = ^(double progress){
             dispatch_async(dispatch_get_main_queue(), ^(){
-                self.statusController.progressValue = progress * 100.0;
+                if (installer.supportsDeterminateProgress) {
+                    self.statusController.progressValue = progress * 100.0;
+                }
             });
         };
 
diff --git a/Sparkle/SUFileManager.m b/Sparkle/SUFileManager.m
index 8ede3a8d..be4a8f83 100644
--- a/Sparkle/SUFileManager.m
+++ b/Sparkle/SUFileManager.m
@@ -10,6 +10,7 @@
 #import "SUOperatingSystem.h"
 #import "SUFileOperationConstants.h"
 
+#import "SULog.h"
 #import "SUErrors.h"
 
 #include <sys/xattr.h>
@@ -320,7 +321,7 @@ - (BOOL)_removeQuarantineWithAuthenticationAtRootURL:(NSURL *)rootURL error:(NSE
         return NO;
     }
 
-    NSLog(@"Sparkle: Authorization required to remove quarantine %@", rootURL);
+    SULog(SULogLevelDefault, @"Sparkle: Authorization required to remove quarantine: %@", rootURL);
 
     NSError *executeError = nil;
     BOOL success = [self _authorizeAndExecuteCommand:SUFileOpRemoveQuarantineCommand sourcePath:path destinationPath:NULL error:&executeError];
@@ -520,7 +521,7 @@ - (BOOL)copyItemAtURL:(NSURL *)sourceURL toURL:(NSURL *)destinationURL error:(NS
         return NO;
     }
 
-    NSLog(@"Sparkle: Authorization required to copy %@ to %@", sourceURL, destinationURL);
+    SULog(SULogLevelDefault, @"Sparkle: Authorization required to copy %@ to %@", sourceURL, destinationURL);
 
     NSError *executeError = nil;
     if (![self _authorizeAndExecuteCommand:SUFileOpCopyCommand sourcePath:sourcePath destinationPath:destinationPath error:&executeError]) {
@@ -614,7 +615,7 @@ - (BOOL)moveItemAtURL:(NSURL *)sourceURL toURL:(NSURL *)destinationURL error:(NS
         return NO;
     }
 
-    NSLog(@"Sparkle: Authorization required to move %@ to %@", sourceURL, destinationURL);
+    SULog(SULogLevelDefault, @"Sparkle: Authorization required to move %@ to %@", sourceURL, destinationURL);
 
     char sourcePath[PATH_MAX] = {0};
     if (![sourceURL.path getFileSystemRepresentation:sourcePath maxLength:sizeof(sourcePath)]) {
@@ -785,7 +786,7 @@ - (BOOL)changeOwnerAndGroupOfItemAtRootURL:(NSURL *)targetURL toMatchURL:(NSURL
         return NO;
     }
 
-    NSLog(@"Sparkle: Authorization required to change permissions of %@ to match %@", targetURL, matchURL);
+    SULog(SULogLevelDefault, @"Sparkle: Authorization required to change permissions of %@ to match %@", targetURL, matchURL);
 
     NSError *executeError = nil;
     BOOL success = [self _authorizeAndExecuteCommand:SUFileOpChangeOwnerAndGroupCommand sourcePath:targetPath destinationPath:matchPath error:&executeError];
@@ -844,7 +845,7 @@ - (BOOL)updateModificationAndAccessTimeOfItemAtURL:(NSURL *)targetURL error:(NSE
         return NO;
     }
 
-    NSLog(@"Sparkle: Authorization required to update timestamp of %@", targetURL);
+    SULog(SULogLevelDefault, @"Sparkle: Authorization required to update timestamp of %@", targetURL);
 
     NSError *executeError = nil;
     BOOL success = [self _authorizeAndExecuteCommand:SUFileOpUpdateModificationAndAccessTimeCommand sourcePath:path destinationPath:NULL error:&executeError];
@@ -888,7 +889,7 @@ - (BOOL)makeDirectoryAtURL:(NSURL *)url error:(NSError * __autoreleasing *)error
         return NO;
     }
 
-    NSLog(@"Sparkle: Authorization required to make directory %@", url);
+    SULog(SULogLevelDefault, @"Sparkle: Authorization required to make directory %@", url);
 
     char path[PATH_MAX] = {0};
     if (![url.path getFileSystemRepresentation:path maxLength:sizeof(path)]) {
@@ -952,7 +953,7 @@ - (BOOL)removeItemAtURL:(NSURL *)url error:(NSError * __autoreleasing *)error
         return NO;
     }
 
-    NSLog(@"Sparkle: Authorization required to delete %@", url);
+    SULog(SULogLevelDefault, @"Sparkle: Authorization required to delete %@", url);
 
     char path[PATH_MAX] = {0};
     if (![url.path getFileSystemRepresentation:path maxLength:sizeof(path)]) {
@@ -990,7 +991,7 @@ - (BOOL)executePackageAtURL:(NSURL *)packageURL progressBlock:(void(^)(double))p
         return NO;
     }
 
-    NSLog(@"Sparkle: Authorization required to run pkg installer %@", packageURL);
+    SULog(SULogLevelDefault, @"Sparkle: Authorization required to run pkg installer %@", packageURL);
 
     NSError *executeError = nil;
     BOOL success = [self _authorizeAndExecuteCommand:SUFileOpInstallCommand sourcePath:path destinationPath:NULL lineCallback:^(NSString *line){
diff --git a/Sparkle/SUGuidedPackageInstaller.m b/Sparkle/SUGuidedPackageInstaller.m
index 9c8e6e50..8eecd707 100644
--- a/Sparkle/SUGuidedPackageInstaller.m
+++ b/Sparkle/SUGuidedPackageInstaller.m
@@ -54,4 +54,11 @@ - (BOOL)canInstallSilently
     return YES;
 }
 
+// We used to, but it broke due to fragile text processing
+// Maybe one day someone will fix it, but until then.
+- (BOOL)supportsDeterminateProgress
+{
+    return NO;
+}
+
 @end
diff --git a/Sparkle/SUInstallerProtocol.h b/Sparkle/SUInstallerProtocol.h
index 75312c47..599aa39f 100644
--- a/Sparkle/SUInstallerProtocol.h
+++ b/Sparkle/SUInstallerProtocol.h
@@ -31,6 +31,8 @@ NS_ASSUME_NONNULL_BEGIN
 // Should be thread safe
 - (NSString *)installationPath;
 
+- (BOOL)supportsDeterminateProgress;
+
 @end
 
 NS_ASSUME_NONNULL_END
diff --git a/Sparkle/SUPackageInstaller.m b/Sparkle/SUPackageInstaller.m
index ca2e4e7b..eba0d66e 100644
--- a/Sparkle/SUPackageInstaller.m
+++ b/Sparkle/SUPackageInstaller.m
@@ -78,4 +78,9 @@ - (BOOL)canInstallSilently
     return NO;
 }
 
+- (BOOL)supportsDeterminateProgress
+{
+    return NO;
+}
+
 @end
diff --git a/Sparkle/SUPlainInstaller.m b/Sparkle/SUPlainInstaller.m
index ec51b644..0cd5c041 100644
--- a/Sparkle/SUPlainInstaller.m
+++ b/Sparkle/SUPlainInstaller.m
@@ -265,4 +265,9 @@ - (BOOL)canInstallSilently
     return YES;
 }
 
+- (BOOL)supportsDeterminateProgress
+{
+    return YES;
+}
+
 @end
-- 
2.29.2 (Apple Git-129)

